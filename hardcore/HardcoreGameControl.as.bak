package hardcore{
	//For the hardcore challenge event, also with HardcoreHomeUI
	
	import flash.events.Event;
	import flash.display.Sprite;
	import items.ItemData;
	import items.ItemView;
	import items.ItemModel;
	import flash.geom.Matrix;
	import ui.GameUI;
	import ui.windows.EndWindow;
	import ui.assets.TutorialWindow;
	import utils.GameData;
	import ui.effects.FlyingText;
	import gameEvents.*;
	import ui.windows.ConfirmWindow;
	import system.buffs.BuffData;
	import system.actions.ActionBase;
	import system.effects.EffectBase;
	import system.effects.EffectData;
	import utils.PlayfabAPI;
	import utils.KongregateAPI;
	import ui.assets.AchievementDisplay;
	
	public class HardcoreGameControl extends GameControl{
		/*public static const TURN_LENGTH:int=30;
		public static const BUFF_DELAY:int=10;

		public var gameM:GameModel;
		public var gameV:Sprite;
		public var gameUI:GameUI;
		
		public var delay:int;
		var spawn:int;
		public var turboB:Boolean;
		public var running:Boolean;
		
		public var roundWait:Boolean=false;*/
		override public function playerDead(_v:SpriteModel){
			if (!running) return;
			//You Die!
			
			PlayfabAPI.deletePlayerData(["player-100"]);
			Facade.gameM.playerM.saveSlot=-1;
			if (gameUI.goingTown){
				gameUI.navOut();
			}else{
				new EndWindow("You have died!\nYour challenge is ended... sorry... :(",navOut,navOut,false);
			}
		}
		
		override public function enemyDead(_o:SpriteModel, _t:SpriteModel){
			gameM.turn=true;
			
			gameUI.background.addObject(gameM.enemyM.view.getBitmap());
			gameM.enemyM.exists=false;
			gameM.enemyM.view.parent.removeChild(gameM.enemyM.view);
			//gameUI.updateStatus(gameM.playerM);
			gameUI.updateStatus(gameM.enemyM,true);
			
			gameM.distance=GameModel.BETWEEN;
			gameM.playerM.attackTarget=null;
			gameM.enemyM.attackTarget=null;
			var _effect:EffectBase=gameM.playerM.stats.findDisplay(EffectData.FIND_STACKS);
			if (_effect!=null){
				if (GameModel.random()<_effect.modify(gameM.playerM).userate){
					gameM.playerM.increaseBeltStack(_effect.values);
					new FlyingText(gameM.playerM,"Found Stacks!",0xaaffaa);
				}
			}
			gameM.playerM.buffList.clearEndFight();
			
			if (gameM.eCount==gameM.eTotal){
				getBossReward();
				nextLevel();
			}else{
				getMobReward();
				GameData.saveCharacterGame(Facade.gameM.playerM.saveSlot,Facade.saveC.getArray(Facade.gameM.playerM));
			}
		}
		
		function getZoneItemLevel(_zone:int):int{
			var m:int=_zone/10;
			for (var i:int=10;m>i;i+=10){
				m=i+(m-i)/2;
			}
			return m;
		}
		
		function zoneLevelup(_zone:int):Boolean{
			var i:int=_zone+20;
			var mod:int=0;
			while (i>20){
				i/=1.75;
				mod+=1;
			}
			if (_zone%mod==0) return true;
			
			return false;
		}
		
		function findItem(level:int):ItemModel{
			var m:ItemModel;
			switch(Math.floor(Math.random()*15)){
				case 0: case 1: case 2: m=ItemData.randomItem(ItemData.WEAPON,level);
					ItemData.enchantItem(m);
					break;
				case 3: case 4: m=ItemData.randomItem(ItemData.HELMET,level);
					ItemData.enchantItem(m);
					break;
				case 10: case 5: m=ItemData.randomItem(ItemData.MAGIC,level); break;
				case 11: case 6: m=ItemData.randomItem(ItemData.PROJECTILE,level); 
					ItemData.enchantItem(m);
					m.charges=m.maxCharges();
					break;
				case 7: m=ItemData.randomItem(ItemData.SCROLL,level); break;
				case 8: case 9: 
					var i:int=1+Math.floor(Math.random()*29);
					var j:int;
					switch(i){
						case 11: case 12: case 13: case 27: case 28: case 29: j=40; break;
						case 3: case 4: case 7: case 8: case 9: case 10: j=41; break;
						case 5: case 15: case 17: case 19: case 24: case 26: j=42; break;
						case 1: case 2: case 14: case 16: case 18: j=43; break;
						case 6: case 20: case 21: case 22: case 23: case 25: j=44; break;
					}
					m=ItemData.enchantItem(ItemData.spawnItem(level,j),i);
					break;
				
				case 12: case 13: case 14: m=ItemData.randomItem(ItemData.POTION,level); break;
				default: null;
			}
			
			return m;
		}
		
		function getBossReward(){
			if (Math.random()<0.01){
				if (gameM.area%2==0){
					gameUI.addItem(new ItemView(ItemData.enchantItem(ItemData.randomItem(ItemData.POTION,getZoneItemLevel(gameM.area)),6)),-1,true);
				}else{
					gameUI.addItem(new ItemView(ItemData.enchantItem(ItemData.randomItem(ItemData.SCROLL,getZoneItemLevel(gameM.area)),6)),-1,true);
				}
			}else{
				gameUI.addItem(new ItemView(ItemData.spawnPremium(getZoneItemLevel(gameM.area),true)),-1,true);
			}
			gameUI.progress+=1;
			if (zoneLevelup(gameM.area)){
				gameM.playerM.levelup();
			}
			
			if (gameM.area>100 && gameM.area<=300 && (gameM.area-100)%20==0){
				new AchievementDisplay(316);
			}
			switch(gameM.area){
				case 50:
					gameM.playerM.arts[1]=null;
					new AchievementDisplay(317);
					break;
				case 100:
					gameM.playerM.arts[3]=null;
					new AchievementDisplay(317);
					break;
				case 150:
					gameM.playerM.arts[0]=null;
					new AchievementDisplay(317);
					break;
				case 250:
					gameM.playerM.arts[4]=null;
					new AchievementDisplay(317);
					break;
			}
		}
			
		public function getArtifactLevel(_zone:int):int{
			return Math.min(Math.max((_zone-100)/20,0),10)
		}
		
		function getMobReward(){
			gameUI.addItem(new ItemView(findItem(getZoneItemLevel(gameM.area))),-1,true);
			gameUI.progress+=1;
			GameData.addScore(GameData.SCORE_KILLS,1);
		}
		
		override public function nextLevel(_areaType:int=-1){
			gameUI.background.addLast();
			
			do{
				var _aType:int=Math.floor(Math.random()*3);
			}while(_aType==gameM.areaType);
			do{
				var _eType:int=Math.floor(Math.random()*3);
			}while(_eType==gameM.enemyType);
			gameM.setupArea(gameM.area+1,_aType,_eType);
			
			gameM.deathStreak=0;
			spawn=99;
			for (var i:int=0;i<Facade.gameM.playerM.belt.length;i+=1){
				var _item:ItemModel=Facade.gameM.playerM.belt[i];
				if (_item!=null && _item.slot==ItemData.USEABLE && _item.charges>=0 && _item.charges<_item.maxCharges()){
					_item.charges=_item.maxCharges();
				}
			}
			GameData.setHardcore(gameM.area);
			GameEventManager.addGameEvent(GameEvent.CHALLENGE_AREA_REACHED,gameM.area);
			
			GameData.saveCharacterGame(Facade.gameM.playerM.saveSlot,Facade.saveC.getArray(Facade.gameM.playerM));
		}
		
		override public function newEnemy(){
			EnemyData.newCreature(gameM.enemyM);
			gameM.enemyM.view.y=GameUI.FLOOR_Y;
			gameM.enemyM.view.x=GameUI.VIEW_WIDTH+100;
			gameV.addChild(gameM.enemyM.view);
		}

		override public function newBoss(){
			EnemyData.newBoss(gameM.enemyM);
			gameM.enemyM.view.y=GameUI.FLOOR_Y;
			gameM.enemyM.view.x=GameUI.VIEW_WIDTH+50;
			gameV.addChild(gameM.enemyM.view);
			GameEventManager.addGameEvent(GameEvent.ENCOUNTER_BOSS,gameM.enemyM);
		}
		
		public static var eliminated:Array=["8z8z","bonez893","ipakerok","archaeryon","lordasmodai","lounsbery","OneWingedDevil","quesa74","tepduang","Pyromax87","huangex","AoshiSlayer","User2351","Battenberger","D00mM0le","virtual_maniac","kasugol","stewber","neit314","nn330303","deathtyrant","","iaziuh","ChaosLeo","frithjofbau","Zenechi","Voltage_02","firauza","Cbone12345","huntard108","Voldurike","131712pt","elute11","zver8","aquacowz","gruobmenork","asskimo","skot626","mon2","ThePokemonMew","Krelian970","deadfall500","ImaLeadFarmer","sschilz","BinyaminTsadik","lol146","Colbei","demonspawn0001","Sophisanmus","denbart93","Canquinary_fox","dinhkhoa921004"];
		public static function getEliminatedPosition():int{
			var _name:String=KongregateAPI.getName();
			for (var i:int=0;i<eliminated.length;i+=1){
				if (eliminated[i]==_name){
					 return 1+i;
				}
			}
			return 99;
		}
	}
}